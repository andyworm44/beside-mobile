# 📐 架構說明

## 你的應用架構

```
手機 App (TestFlight)
    ↓ HTTP 請求
Express.js 後端服務器 (beside-backend)
    ↓ 連接
Supabase (數據庫 + 認證)
```

## 🔍 詳細說明

### 1. **Supabase**（雲端）
- ✅ **數據庫**：存儲用戶、信號、回應等數據
- ✅ **認證服務**：用戶登入/註冊
- ✅ **已經在雲端**，不需要部署

### 2. **Express.js 後端**（本地）
- ❌ **目前運行在本地**：`localhost:3001` 或 `10.45.216.238:3001`
- 📡 **作用**：
  - 提供 REST API 端點（`/api/v1/auth/register`, `/api/v1/signals` 等）
  - 處理業務邏輯（繞過 RLS、計算年齡、統計等）
  - 連接 Supabase 並處理數據
- ⚠️ **問題**：TestFlight 的 app 無法訪問本地服務器

### 3. **手機 App**
- 通過 HTTP 請求連接到 Express 後端
- **不直接**連接到 Supabase

---

## ❓ 為什麼需要 Express 後端？

你的代碼中，Express 後端處理了很多業務邏輯：

1. **繞過 RLS**：使用 `supabaseAdmin` 創建信號、回應等
2. **計算年齡**：從生日計算年齡（如：25歲）
3. **統計數據**：計算發送信號數、收到回應數等
4. **業務規則**：限制回應數量、過濾邏輯等

這些邏輯**不能**直接在手機 App 中完成，因為：
- 手機 App 使用 `supabase`（普通用戶權限），無法繞過 RLS
- 需要 `supabaseAdmin`（服務端權限）才能執行某些操作

---

## ✅ 解決方案

### 方案 1：部署 Express 後端到雲端（推薦）

將 `beside-backend` 部署到雲端服務器，這樣 TestFlight 的 app 就能訪問了。

**選項 A：Railway（最簡單）**
- 免費試用，之後 $5/月
- 自動部署，簡單配置
- 15 分鐘完成

**選項 B：Render**
- 免費層可用
- 簡單配置
- 約 20 分鐘完成

**選項 C：Fly.io**
- 免費層可用
- 需要 CLI 配置
- 約 30 分鐘完成

### 方案 2：簡化架構（需要重寫）

將所有業務邏輯移到 Supabase Edge Functions 或直接在手機 App 中使用 Supabase SDK。

⚠️ **需要大量重寫代碼，不推薦現在做**

---

## 🎯 推薦流程

**現在**：部署 Express 後端到 Railway（15分鐘）
**之後**：如果需要，可以考慮簡化架構

---

## 📝 總結

- **Supabase** = 數據庫（雲端）✅
- **Express 後端** = 業務邏輯服務器（需要部署）❌
- **部署** = 將 Express 後端放到雲端，讓 TestFlight 能訪問

**下一步**：我幫你部署 Express 後端到 Railway，還是你想用其他服務？







